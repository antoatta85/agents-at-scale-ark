apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: agent-parameters
  labels:
    multi-provider: "true"
spec:
  steps:
    - name: setup-and-test
      try:
      - script:
          skipLogOutput: true
          content: |
            ../scripts/setup-model-provider.sh auto
          outputs:
          - name: provider
            value: (json_parse($stdout))
      - apply:
          resource:
            apiVersion: v1
            kind: Secret
            metadata:
              name: test-model-token
            type: Opaque
            data:
              token: (base64_encode($provider.token))
      - apply:
          file: (join('', ['manifests/a01-model-', $provider.type, '.yaml']))
      - apply:
          file: "manifests/a02-configmap.yaml"
      - apply:
          file: "manifests/a03-secret-params.yaml"
      - apply:
          file: "manifests/a05-agent.yaml"
      - assert:
          resource:
            apiVersion: v1
            kind: ConfigMap
            metadata:
              name: agent-config
      - assert:
          resource:
            apiVersion: v1
            kind: Secret
            metadata:
              name: agent-secrets
      - assert:
          resource:
            apiVersion: ark.mckinsey.com/v1alpha1
            kind: Model
            metadata:
              name: test-model
            status:
              conditions:
                - type: ModelAvailable
                  status: "True"
      - assert:
          resource:
            apiVersion: ark.mckinsey.com/v1alpha1
            kind: Agent
            metadata:
              name: test-agent-with-params