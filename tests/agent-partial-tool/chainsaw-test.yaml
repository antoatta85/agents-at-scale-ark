apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: agent-partial-tool
  labels:
    multi-provider: "true"
spec:
  description: Test agent with a tool using partial parameters
  steps:
    - name: setup-and-test
      try:
      - script:
          skipLogOutput: true
          content: |
            ../scripts/setup-model-provider.sh auto
          outputs:
          - name: provider
            value: (json_parse($stdout))
      - apply:
          resource:
            apiVersion: v1
            kind: Secret
            metadata:
              name: test-model-token
            type: Opaque
            data:
              token: (base64_encode($provider.token))
      - apply:
          file: (join('', ['manifests/a01-model-', $provider.type, '.yaml']))
      - apply:
          file: manifests/a03-tool.yaml
      - apply:
          file: manifests/a04-agent.yaml
      - apply:
          file: manifests/a05-query.yaml
      - assert:
          resource:
            apiVersion: ark.mckinsey.com/v1alpha1
            kind: Model
            metadata:
              name: test-model
            status:
              conditions:
              - type: ModelAvailable
                status: "True"
      - assert:
          resource:
            apiVersion: ark.mckinsey.com/v1alpha1
            kind: Query
            metadata:
              name: partial-tool-query
            status:
              (conditions[?type == 'Completed']):
              - status: 'True'
