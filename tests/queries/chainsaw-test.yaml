apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: queries
  labels:
    multi-provider: "true"
spec:
  steps:
    - name: setup-and-test
      try:
      - script:
          skipLogOutput: true
          content: |
            ../scripts/setup-model-provider.sh auto
          outputs:
          - name: provider
            value: (json_parse($stdout))
      - script:
          content: |
            helm install ark-tenant ../../charts/ark-tenant --namespace $NAMESPACE --create-namespace --wait
          env:
          - name: NAMESPACE
            value: ($namespace)
      - apply:
          resource:
            apiVersion: v1
            kind: Secret
            metadata:
              name: test-model-token
            type: Opaque
            data:
              token: (base64_encode($provider.token))
      - apply:
          file: (join('', ['manifests/a01-model-', $provider.type, '.yaml']))
      - apply:
          file: manifests/a03-agent.yaml
      - apply:
          file: manifests/a04-query.yaml
      - assert:
          resource:
            apiVersion: ark.mckinsey.com/v1alpha1
            kind: Model
            metadata:
              name: default
            status:
              conditions:
              - type: ModelAvailable
                status: "True"
      - assert:
          resource:
            apiVersion: ark.mckinsey.com/v1alpha1
            kind: Agent
            metadata:
              name: test-agent
      - assert:
          resource:
            apiVersion: ark.mckinsey.com/v1alpha1
            kind: Query
            metadata:
              name: test-query
            status:
              (conditions[?type == 'Completed']):
              - status: 'True'
      - assert:
          resource:
            apiVersion: ark.mckinsey.com/v1alpha1
            kind: Query
            metadata:
              name: test-query
            status:
              (response != null): true
              (response.target.name): 'test-agent'
              (length(response.content) > `10`): true
      catch:
      - events: {}
      - describe:
          apiVersion: ark.mckinsey.com/v1alpha1
          kind: Query
          name: test-query