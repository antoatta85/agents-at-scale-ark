# DevSpace configuration for ark-api service
version: v2beta1

# Environment variables - defaults to local Keycloak, can be overridden
vars:
  AUTH_MODE:
    source: env
    default: "sso"
  OIDC_ISSUER_URL:
    source: env
    default: "http://host.docker.internal:8090/realms/ark-test"
  OIDC_APPLICATION_ID:
    source: env
    default: "ark-api"
  CORS_ORIGINS:
    source: env
    default: "http://localhost:3000"

images:
  ark-api:
    image: ark-api
    dockerfile: Dockerfile
    context: .

dependencies:
  ark-sdk:
    path: ../../lib/ark-sdk

pipelines:
  deploy: |-
    run_dependency_pipelines --all --pipeline=deploy
    ./sync-ark-sdk.sh
    build_images --all
    create_deployments --all
  dev: |-
    run_dependency_pipelines --all --pipeline=dev
    ./sync-ark-sdk.sh
    create_deployments --all
    start_dev --all

deployments:
  ark-api:
    namespace: default
    helm:
      chart:
        path: ./chart
      values:
        app:
          image:
            repository: ${runtime.images.ark-api.image}
            tag: ${runtime.images.ark-api.tag}
          # Override resources for local development
          resources:
            limits:
              memory: "1024Mi"
              cpu: "1000m"
            requests:
              memory: "256Mi"
              cpu: "200m"
          env:
            - name: AUTH_MODE
              value: ${vars.AUTH_MODE}
            - name: OIDC_ISSUER_URL
              value: ${vars.OIDC_ISSUER_URL}
            - name: OIDC_APPLICATION_ID
              value: ${vars.OIDC_APPLICATION_ID}
            - name: CORS_ORIGINS
              value: ${vars.CORS_ORIGINS}
        httpRoute:
          enabled: true

dev:
  ark-api:
    imageSelector: ark-api
    devImage: python:3.12-slim
    env:
      - name: AUTH_MODE
        value: "sso"
      - name: OIDC_ISSUER_URL
        value: "http://192.168.100.3:8090/realms/ark-test"
      - name: OIDC_APPLICATION_ID
        value: "ark-api"
      - name: CORS_ORIGINS
        value: "http://localhost:3000"
    # Install dependencies and start API server with hot reload
    command:
      [
        "sh",
        "-c",
        "cd /app/ark-api && apt-get update && apt-get install -y curl && curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash && pip install uv && uv add file://$(ls /app/out/ark_sdk-*.whl) && uv sync && uv run uvicorn ark_api.main:app --host 0.0.0.0 --port 8000 --reload",
      ]
    namespace: default
    # Stream logs instead of terminal
    logs:
      lastLines: 50
    # File synchronization for hot reload
    sync:
      - path: .:/app
        startContainer: true
        disableDownload: true
        uploadExcludeFile: .dockerignore
      - path: ./out:/app/out/
        startContainer: true
        disableDownload: true
        onUpload:
          restartContainer: true
      - path: ../../ark:/workspace
        excludePaths:
          - bin/
          - out/
          - .git/
    # Enable SSH for IDE integration
    ssh:
      enabled: true

