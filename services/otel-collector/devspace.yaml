version: v2beta1

vars:
  HTTPROUTE_ENABLED:
    command: |-
      if kubectl get crd httproutes.gateway.networking.k8s.io >/dev/null 2>&1; then
        echo "true"
      else
        echo "false"
      fi

pipelines:
  dev: |-
    create_deployments --all

deployments:
  otel-collector:
    namespace: otel-collector
    helm:
      chart:
        path: ./chart
      values:
        httpRoute:
          enabled: ${HTTPROUTE_ENABLED}
        otelEnvironmentVariableSecrets:
          enabled: true
          namespaces:
            - ark-system
            - default

hooks:
  - command: |-
      if kubectl get crd httproutes.gateway.networking.k8s.io >/dev/null 2>&1; then
        echo "✓ Gateway API HTTPRoute CRD found - HTTPRoute will be created"
      else
        echo "✗ Gateway API HTTPRoute CRD not found - HTTPRoute will be skipped"
      fi
    events: ["before:deploy:otel-collector"]
  - command: |-
      echo "Restarting ark-controller to pick up OpenTelemetry Collector configuration..."

      if kubectl get deployment ark-controller-devspace -n ark-system >/dev/null 2>&1; then
        echo "Found ark-controller-devspace, restarting..."
        kubectl rollout restart deployment/ark-controller-devspace -n ark-system
        kubectl rollout status deployment/ark-controller-devspace -n ark-system --timeout=120s
      elif kubectl get deployment ark-controller -n ark-system >/dev/null 2>&1; then
        echo "Found ark-controller, restarting..."
        kubectl rollout restart deployment/ark-controller -n ark-system
        kubectl rollout status deployment/ark-controller -n ark-system --timeout=120s
      else
        echo "Warning: No ark-controller deployment found in ark-system namespace"
      fi

      echo ""
      echo "OpenTelemetry Collector: http://otel-collector-svc.otel-collector.127.0.0.1.nip.io:8080"
      echo "Port-forward OTLP HTTP: kubectl port-forward -n otel-collector svc/otel-collector-svc 4318:4318"
      echo "Port-forward OTLP gRPC: kubectl port-forward -n otel-collector svc/otel-collector-svc 4317:4317"
    events: ["after:deploy:otel-collector"]
