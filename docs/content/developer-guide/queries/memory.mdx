# Memory

Memory enables persistent conversation context across queries. When a query references a memory resource, ARK stores conversation history and provides it as context for subsequent queries in the same session.

## Agent Query with Memory

```yaml
apiVersion: ark.mckinsey.com/v1alpha1
kind: Query
metadata:
  name: agent-memory-query
spec:
  input: "Hello! My name is John. Please remember this for our conversation."
  memory:
    name: default
  targets:
    - type: agent
      name: my-agent
  sessionId: user-session-123
```

## Team Query with Memory

```yaml
apiVersion: ark.mckinsey.com/v1alpha1
kind: Query
metadata:
  name: team-memory-query
spec:
  input: "Let's work on the project together"
  memory:
    name: default
  targets:
    - type: team
      name: my-team
  sessionId: team-session-456
```

## System Message Behavior

ARK **always stores** system messages (agent prompts) in memory for debugging and audit purposes. However, whether system messages are **loaded back** into the conversation context is controlled by a query-level annotation.

### Behavior Without Annotation (Default)

By default, system messages are **stored** but **not hydrated** (not loaded back):

1. **Initial Query**: If you create a 'coder' agent with prompt "You translate code to JavaScript" and run a query, ARK stores the system message in memory
2. **Agent Update**: Someone changes the agent prompt to "You translate code to Python"  
3. **Follow-up Query**: When you run a follow-up query, ARK uses the **current** agent prompt (Python) for execution, not the stored one

This is the default and recommended behavior for most use cases.

### Controlling System Message Hydration

Use the `ark.mckinsey.com/memory-hydrate-system-message: "true"` annotation **on the Query** to load system messages from memory:

```yaml
apiVersion: ark.mckinsey.com/v1alpha1
kind: Query
metadata:
  name: follow-up-query
  annotations:
    ark.mckinsey.com/memory-hydrate-system-message: "true"
spec:
  input: "create a unit test for this"
  sessionId: user-session-123
  memory:
    name: default
  targets:
    - type: agent
      name: coder-agent
```

With this annotation:
- The **historical** system message from memory is used (e.g., "JavaScript translator")
- Even if the agent's current prompt is "Python translator", the query will use the prompt that was active when the conversation started
- Useful for preserving conversation context or debugging

## Examples

A complete test suite demonstrating system message hydration is available in the repository:

**Location**: `samples/test-system-message-hydration/`

This directory includes:
- `01-create-agent.yaml` - Creates the test agent
- `02-start-conversation.yaml` - Stores system message in memory
- `04-query-without-hydration.yaml` - Uses current agent prompt (default behavior)
- `05-query-with-hydration.yaml` - Uses historical prompt from memory (with annotation)
- `README.md` - Complete usage instructions

**Note**: The annotation works for both agent queries and team queries. Simply add it to the query metadata when needed.

### Use Cases

**Default Behavior (No annotation)**: Use when you want agents to always use their current prompt
- Most production scenarios
- When prompts are stable
- When you want prompt updates to apply immediately

**With Annotation**: Use when you need historical prompt preservation
- Debugging conversations with original prompts
- Agent prompts changed mid-conversation
- Audit compliance (know which prompt version was used)
- A/B testing different prompt versions
