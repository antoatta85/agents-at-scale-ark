# Ark API Server

Aggregated API Server for Ark resources with pluggable storage backends.

## Overview

The Ark API Server is a Kubernetes [aggregated API server](https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/apiserver-aggregation/) that stores Ark resources outside of etcd. This addresses scalability limitations when running high-volume AI workloads.

### Supported Resources

All 10 Ark resource types are supported:

| Resource | Description |
|----------|-------------|
| Query | AI query requests and responses |
| Agent | AI agent definitions with prompts and tools |
| Model | AI model configurations (OpenAI, Azure, Bedrock) |
| Team | Multi-agent team orchestration |
| Tool | Tool definitions (HTTP, MCP, builtin) |
| Memory | Conversation memory persistence |
| MCPServer | MCP server connections |
| Evaluation | AI output evaluation jobs |
| Evaluator | Evaluation service configuration |
| A2ATask | Agent-to-agent task coordination |

## Why Not etcd?

Kubernetes stores all resources in etcd, which has practical limits:
- ~10-20k writes/sec shared across the entire cluster
- Queries generate 3-4 writes each (create, status updates, completion)
- High Query volume can impact cluster operations (pod scheduling, etc.)

The Ark API Server solves this by storing Ark resources in a dedicated database while maintaining full Kubernetes API compatibility.

## Architecture

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         Kubernetes Cluster                               │
│                                                                          │
│   kubectl get queries       kubectl get pods                            │
│        │                         │                                       │
│        ▼                         ▼                                       │
│   ┌─────────────────────────────────────────────┐                       │
│   │              kube-apiserver                  │                       │
│   └─────────────────┬───────────────────────────┘                       │
│        ┌────────────┴────────────┐                                      │
│        ▼                         ▼                                       │
│   ┌──────────┐            ┌──────────────┐                              │
│   │  Core    │            │  Ark API     │  ← Aggregated API            │
│   │  (etcd)  │            │  Server      │                              │
│   │          │            │              │                              │
│   │  pods    │            │  queries     │                              │
│   │  services│            │  agents      │                              │
│   └──────────┘            │  models      │                              │
│                           └──────┬───────┘                              │
│                                  │                                       │
│                                  ▼                                       │
│                           ┌──────────────┐                              │
│                           │   Storage    │                              │
│                           │  SQLite /    │                              │
│                           │  PostgreSQL  │                              │
│                           └──────────────┘                              │
└─────────────────────────────────────────────────────────────────────────┘
```

## Storage Backends

### SQLite (Default)

Zero-configuration storage for development and small deployments.

- Single file database with WAL mode
- No external dependencies
- Suitable for development and single-node deployments
- Automatic schema initialization

### PostgreSQL

Production-ready storage with connection pooling.

- LISTEN/NOTIFY for efficient real-time WATCH events
- Connection pooling (25 max open, 5 idle)
- GIN indexes for label selector queries
- Automatic trigger-based change notifications
- Horizontal scaling support

## Configuration

### Helm Values

```yaml
storage:
  driver: sqlite  # or postgresql

  sqlite:
    path: /data/ark.db
    persistence:
      enabled: true
      size: 1Gi

  postgresql:
    host: postgres.example.com
    port: 5432
    database: ark
    username: ark
    existingSecret: ark-db-credentials
```

## Development

```bash
cd services/ark-apiserver

make help          # Show available commands
make generate      # Regenerate deepcopy after type changes
make build-binary  # Build locally
make test          # Run tests
make dev           # Run in development mode
```

### Running Tests

**SQLite tests** (no dependencies):
```bash
go test ./pkg/storage/sqlite/...
```

**PostgreSQL integration tests** (requires PostgreSQL):
```bash
# Start PostgreSQL (e.g., via Docker)
docker run -d --name ark-postgres \
  -e POSTGRES_DB=ark \
  -e POSTGRES_USER=ark \
  -e POSTGRES_PASSWORD=arktest \
  -p 5432:5432 postgres:15

# Run tests
POSTGRES_HOST=localhost \
POSTGRES_DB=ark \
POSTGRES_USER=ark \
POSTGRES_PASSWORD=arktest \
go test -v ./pkg/storage/postgresql/...
```

## Current Status

**Phase 2 (Current):**
- All 10 resource types implemented
- SQLite and PostgreSQL backends
- Full CRUD and WATCH support

**Phase 3 (Planned):**
- High availability configuration
- Prometheus metrics
- Performance tuning documentation
